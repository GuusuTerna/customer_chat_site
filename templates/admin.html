<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin Chat</title>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='depop-iconn.png') }}" type="image/png">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .header img {
            height: 50px;
        }
        #messages {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .bubble {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }
        .mine {
            background: #e60023;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .other {
            background: #ddd;
            color: black;
            margin-right: auto;
        }
        #input-area {
            display: flex;
            gap: 10px;
        }
        input, select {
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            background: #e60023;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='depop-iconn.png') }}" alt="Logo">
        <h2>Admin Chat Panel</h2>
    </div>

    <label for="userSelect">Select user to chat with:</label>
    <select id="userSelect">
        <option disabled selected>-- Choose a user --</option>
        {% for user in users %}
            <option value="{{ user }}">{{ user }}</option>
        {% endfor %}
    </select>

    <div id="messages"></div>

    <div id="input-area" style="margin-top: 10px;">
        <input type="text" id="msgInput" placeholder="Reply to user..." />
        <button onclick="sendReply()">Send</button>
    </div>

    <script>
        const socket = io();
        let selectedUser = null;
        const messagesDiv = document.getElementById('messages');
        const userSelect = document.getElementById('userSelect');

        // Restore selected user from ?user= query param
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const restoredUser = urlParams.get('user');
            if (restoredUser) {
                userSelect.value = restoredUser;
                selectedUser = restoredUser;
                socket.emit('load_history', { username: selectedUser });
            }
        };

        userSelect.addEventListener('change', function () {
            selectedUser = this.value;
            // Update URL with selected user to preserve on reload
            const newUrl = window.location.origin + window.location.pathname + '?user=' + selectedUser;
            window.history.replaceState(null, null, newUrl);

            messagesDiv.innerHTML = '';
            socket.emit('load_history', { username: selectedUser });
        });

        socket.on('history', function (data) {
            messagesDiv.innerHTML = '';
            data.messages.forEach(msg => {
                const div = document.createElement('div');
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                bubble.textContent = `[${msg.user}] ${msg.text}`;
                if (msg.user === 'Admin') {
                    bubble.classList.add('mine');
                } else {
                    bubble.classList.add('other');
                }
                div.appendChild(bubble);
                messagesDiv.appendChild(div);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        function sendReply() {
            const input = document.getElementById('msgInput');
            const message = input.value.trim();
            if (message && selectedUser) {
                socket.emit('admin_reply', {
                    to: selectedUser,
                    text: message
                });
                input.value = '';
            }
        }

        socket.on('message', function (data) {
            // Display only messages relevant to the selected user
            if (
                data.user === 'Admin' && data.to === selectedUser ||
                data.user === selectedUser && data.to === 'admin'
            ) {
                const div = document.createElement('div');
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                bubble.textContent = `[${data.user}] ${data.text}`;
                bubble.classList.add(data.user === 'Admin' ? 'mine' : 'other');
                div.appendChild(bubble);
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });
    </script>
</body>
</html>
